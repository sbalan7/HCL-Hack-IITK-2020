from sklearn.ensemble import RandomForestClassifier
import pandas as pd
import numpy as np
import pickle
import json
import os


def dynamic_data_extract(path):
    dataline = pd.DataFrame()
    with open(path) as f:
        data = json.load(f)

        # Extract name hash
        try:
            x = data['target']['file']['sha256']
        except:
            print('File hash misssing for file {}'.format(path))
            x = 0
        finally:
            dataline['name'] = x

        # Extract scores
        try:
            x = data['info']['score']
        except:
            print('File score misssing for file {}'.format(path))
            x = 0
        finally:
            dataline['score'] = x

        # Extract size
        try:
            x = data['target']['file']['size']
        except:
            print('File size misssing for file {}'.format(path))
            x = 0
        finally:
            dataline['size'] = x

        # Extract source
        try:
            x = data['info']['route']
        except:
            print('File route misssing for file {}'.format(path))
            x = 0
        finally:
            dataline['route'] = x
        
        if 'virustotal' in data.keys():
            dataline['virus'] = 1
        else:
            dataline['virus'] = 0

        if 'Benign' in path:
            dataline['target'] = 0
        else:
            dataline['target'] = 1

    return dataline

def dynamic_predict(dataline):
    prediction = dynamic_model.predict(dataline)
    if prediction == 0:
        return {dataline['name']: 'benign'}
    else:
        return {dataline['name']: 'malware'}

dynamic_model = pickle.load(open(os.path.join('Dynamic-Analysis', 'dynamic_model.dtc')))

